<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_ui_page">
    <sys_ui_page action="INSERT_OR_UPDATE">
        <category>general</category>
        <client_script><![CDATA[//获取共通类方法
var utility = x_58872_needit.Utility;
var csvUtility = x_58872_needit.CsvUtility;
var excelUtility = x_58872_needit.ExcelUtility;
var axiosUtility = x_58872_needit.AxiosUtility;

//取得画面参数
var name = gel('helloName').value;
//alert("Hello, "+name);

//取得server端的返回值
var upd = gel('upd').value;
if (upd) {
	alert("ok");
	//alert("收到，"+upd);
	//gel('upd').value = "";
}

var doCancel = function() {
	//gel('searchWord').text = "";
	alert("I am canceled");
	return false;
};

var doSubmit = function() {
	var name = gel('uploadFileName').value;
	var upd2 = gel('upd2').value;
	//未选文件的时候不处理
	if (name == "") {
		alert("请选择文件");
		return false;
	} else if (upd2 == "") {
		alert("未能正确识别文件");
		return false;
	} else {
		return true;
	}
};

$j('input[type=radio][name=fileType]').change(function() {
	// alert(this.value);
	if (this.value == 'CSV') {
		gel('uploadFile').accept = "text/csv";
	}
	else {
		gel('uploadFile').accept = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";
	}
});

$j('#uploadFile').change(function() {
	var name = $j('#uploadFile').prop('value');
	//未选文件的时候不处理
	if (name == "") {
		return;
	}
	var fileObj = $j('#uploadFile').prop('files')[0];
	utility.getLocalFile(fileObj, 'dataURL').then(function(reader) {
		gel('uploadFileName').value = reader.filename;
		gel('upd').value = reader.result;
		//gel('uploadFileType').value = reader.filetype;
		if (reader.filetype == "text/csv") {
			gel('uploadFileType').value = "CSV";
			//解析CSV内容，保存到upd2
			//parseNormalCsv(fileObj, "upd2");
			csvUtility.parseNormalCsv(fileObj, true)
				.then(function(datas) {
					gel('upd2').value = JSON.stringify(datas);
					alert("get " + datas.details.length + " data lines");
				}).catch(function(message) {
					alert(message);
					gel('upd2').value = "";
				});
		} else {
			gel('uploadFileType').value = "Excel";
			// 解析Excel内容，保存到upd2
			// parseNormalExcel(fileObj, "upd2");
			// var params = ["string", "string", "formula", "string", "number", "number", "number", "number"];
			var params = ["string", "string", "string", "string", "number", "number", "number", "number"];
			excelUtility.parseNormalExcel(fileObj, params, true)
				.then(function(datas) {
					gel('upd2').value = JSON.stringify(datas);
					alert("get " + datas.details.length + " data lines");
				}).catch(function(message) {
					alert(message);
					gel('upd2').value = "";
				});
		}
	}).catch(function(reader) {
		gel('upd').value = "";
		gel('upd2').value = "";
		gel('uploadFileName').value = "";
		gel('uploadFileType').value = "";
		alert("文件加载失败");
	});

	//清空原选择框是为了更好的触发onChang事件
	$j('#uploadFile').val("");
});]]></client_script>
        <description/>
        <direct>false</direct>
        <endpoint>x_58872_needit_sample_page2.do</endpoint>
        <html><![CDATA[<?xml version="1.0" encoding="utf-8" ?>
<j:jelly trim="false" xmlns:j="jelly:core" xmlns:g="glide" xmlns:j2="null" xmlns:g2="null">

<g:evaluate>
	//定义searchWord的初始值
	if (typeof searchWord == "undefined") {
		var searchWord = "";
	}
	//定义upd的初始值
	if (typeof upd == "undefined") {
		var upd = "";
	}
	//定义upd2的初始值
	if (typeof upd2 == "undefined") {
		var upd2 = "";
	}
	//定义uploadFileName的初始值
	if (typeof uploadFileName == "undefined") {
		var uploadFileName = "";
	}
	//定义uploadFileType的初始值
	if (typeof uploadFileType == "undefined") {
		var uploadFileType = "";
	}
	//定义uploadTableName的初始值
	if (typeof uploadTableName == "undefined") {
		var uploadTableName = "x_58872_needit_c0_temp";
	}
	//定义helloName的初始值
	if (typeof helloName == "undefined") {
		//获取url参数
		var helloName = RP.getParameterValue("sysparm_fullname");
		if (helloName == "" || helloName == null) {
			helloName = "Everyone";
		}
	}
</g:evaluate>

<!-- 获取uploadTableName下拉框的值 -->
<g:evaluate object="true">
	var upload_tables = [];
	var gr = new GlideRecordSecure("sys_db_object");
	//gr.addQuery("name", "STARTSWITH" , "x_58872");
	//gr.addQuery("super_class", "=" , "c56370e03c31311068bcf327dfe37f82");
	gr.addQuery("sys_scope", "=" , "6ead8e780f603200cd674f8ce1050ed1");
	gr.addQuery("name", "ENDSWITH" , "temp");
	gr.query();
	while (gr.next()) {
		upload_tables.push({"name": gr.getValue("name"), "label": gr.getValue("label")});
	}
</g:evaluate>

<html>
<head>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.js" integrity="sha512-blBYtuTn9yEyWYuKLh8Faml5tT/5YPG0ir9XEABu5YCj7VGr2nb21WPFT9pnP4fcC3y0sSxJR1JqFTfTALGuPQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables.net/2.0.8/dataTables.min.js" integrity="sha512-9nzwD31ljz7rSrA7/yOs/ynFwQT2s2m/k+BAOSI+kz8V/RpkV5bejsjHy8S2yE21ybt4ThoxQ0t4nwsnzQzeRQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script> -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js" integrity="sha512-dlPw+ytv/6JyepmelABrgeYgHI0O+frEwgfnPdXDTOIZz+eDgfW07QXG02/O8COfivBdGNINy+Vex+lYmJ5rxw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" integrity="sha512-Qlv6VSKh1gDKGoJbnyA5RMXYcvnpIqhO++MhIM2fStMcGT9i2T//tSwYFlcyoRRDcDZ+TYHpH8azBBCyhpSeqw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.7.2/axios.min.js" integrity="sha512-JSCFHhKDilTRRXe9ak/FJ28dcpOJxzQaCd3Xg8MyF6XFjODhy/YMCM8HW0TFDckNHWUewW+kfvhin43hKtJxAw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" integrity="sha512-dfX5uYVXzyU8+KHqj8bjo7UkOdg18PaOtpa48djpNbZHwExddghZ+ZmzWT06R5v6NSk3ZUfsH6FNEDepLx9hPQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" integrity="sha512-XMVd28F1oH/O71fzwBnV7HucLxVwtxf26XV8P4wPk26EDxuGZ91N8bsOttmnomcCD3CS5ZMRL50H0GgOHvegtg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<!-- <g:requires name="Utility.jsdbx"/> -->
	<g:evaluate object="true">
		var uiscripts = ["x_58872_needit.Utility", "x_58872_needit.CsvUtility", 
			"x_58872_needit.ExcelUtility", "x_58872_needit.AxiosUtility"];
		var jslibs = [];
		for (var key in uiscripts) {
			var gr = new GlideRecordSecure('sys_ui_script');	
			gr.addQuery("name", uiscripts[key]);
			gr.query();	
			gr.next();	
			jslibs.push( {"name": gr.name, "ts": gr.sys_updated_on } );	
		}
	</g:evaluate>	
	<j:forEach var="jvar_js_lib" indexVar="jvar_js_index" items="${jslibs}">
		<g:evaluate jelly="true">
			var js_lib_name = jelly.jvar_js_lib.name;
			var js_lib_ts = jelly.jvar_js_lib.ts;
		</g:evaluate>
		<g:requires name="${js_lib_name}.jsdbx" params="cache=${js_lib_ts}" />	
	</j:forEach>
	
	<link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.css" />
	<link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid-theme.min.css" />
	<!-- <link type="text/css" rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.css" /> -->
	<!-- 自定义样式 -->
	<style type="text/css">
		select {
			/* margin-bottom: 10px;
			margin-top: 10px; */
			font-family: cursive, sans-serif;
			outline: 0;
			/* background: #2ecc71;
			color: #fff;
			border: 1px solid crimson; */
			padding: 4px;
			border-radius: 9px;
		}
		
		.bottom_area table {
			float: right;
		}

		.bottom_area th, td {
			padding: 5px 5px;
			border-top-width: 0;
			border-left-width: 0;
		}

		.bottom_area button:hover {
			background-color: yellow;
		}
	</style>
</head>

<body text="#FFFFFF">
	<g:ui_form onsubmit="return doSubmit()">
		<table>
			<tbody>
				<tr>
					<td>
						<span class="input-group-radio">
							<input id="radio1" class="radio" type="radio" checked="checked" name="fileType" value="Excel"/>
							<label for="radio1" class="radio-label"> Excel</label>
						</span>
						<span class="input-group-radio">
							<input id="radio2" class="radio" type="radio" name="fileType" value="CSV"/>
							<label for="radio2" class="radio-label"> CSV</label>
						</span>
						<input type="text" class="form-control" name="searchWord" placeholder="条件" value="${searchWord}" cols="50" style="display: none;" />
						<input name="helloName" id="helloName" value="${helloName}" type="hidden" />
					</td>
					<td>
						<input type="file" id="uploadFile" name="uploadFile" accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" />
						<!-- <input type="file" id="uploadFile" name="uploadFile"  /> -->
					</td>
					<td>
						<!-- <g:dialog_buttons_ok_cancel ok="return true" cancel="return doCancel()" /> -->
						<button type="submit" id="submit_button">提交</button>
					</td>
				</tr>
				<tr>
					<td colspan="2"><input type="text" class="form-control" id="uploadFileName" name="uploadFileName" value="${uploadFileName}" cols="50" /></td>
					<td><input type="text" class="form-control" id="uploadFileType" name="uploadFileType" value="${uploadFileType}" cols="50" /></td>
				</tr>
				<tr>
					<td colspan="3">
						<label for="uploadTableName">目标表格：</label>
						<select name="uploadTableName" id="uploadTableName">
							<option value="">请选择目标</option>
							<j:forEach var="jvar_upload_table" items="${upload_tables}">
								<g:evaluate jelly="true">
									var js_upload_table_name = jelly.jvar_upload_table.name;
									var js_upload_table_label = jelly.jvar_upload_table.label;
								</g:evaluate>
								<j:if test="${uploadTableName == js_upload_table_name}">
									<option value="${js_upload_table_name}" selected="true">${js_upload_table_name}</option>
								</j:if>
								<j:if test="${uploadTableName != js_upload_table_name}">
									<option value="${js_upload_table_name}">${js_upload_table_name}</option>
								</j:if>
							</j:forEach>
						</select>
					</td>
				</tr>
				<tr>
					<td colspan="3">
						<textarea id="upd" name="upd" rows="4" cols="100" style="display: none; resize: none;">${upd}</textarea>
					</td>
				</tr>
				<tr>
					<td colspan="3">
						<textarea id="upd2" name="upd2" rows="4" cols="100" style="display: none; resize: none;">${upd2}</textarea>
					</td>
				</tr>
			</tbody>
		</table>
	</g:ui_form>
</body>
</html>
</j:jelly>]]></html>
        <name>sample_page2</name>
        <processing_script><![CDATA[//var p_application = request.getParameter('application_sys_id'); //获取客户端参数的老式写法
//var sysparm_fullname = request.getParameter('jvar_name'); //获取客户端参数的老式写法

//从客户端获取参数，并最终通过定义var变量的形式把值返回给客户端
//var searchWord = searchWord;
//var helloName = helloName;
//var upd = searchWord;
//gs.info("MyDebug -INFO- Received form value for process ->" + application_sys_id);
gs.info("MyDebug -INFO- Received form value for process helloName->" + helloName);
gs.info("MyDebug -INFO- Received form value for process searchWord->" + searchWord);
gs.info("MyDebug -INFO- Received form value for process uploadFileName->" + uploadFileName);
gs.info("MyDebug -INFO- Received form value for process uploadFileType->" + uploadFileType);
gs.info("MyDebug -INFO- Received form value for process uploadTableName->" + uploadTableName);
//gs.info("MyDebug -INFO- Received form value for process ->" + upd);

// var userCount = new global.GlideQuery('x_58872_needit_c0').count();
// gs.info("MyDebug -INFO- x_58872_needit_c0 count ->" + userCount);
// new global.GlideQuery('x_58872_needit_c0').deleteMultiple();
// gs.info("MyDebug -INFO- x_58872_needit_c0 deleted");

var tester = new global.TestGlobal();
//作成datasource，并取得sysid
var dsr = tester.test(uploadFileName, uploadFileType, uploadTableName);
//获取datasource的record
var dataSource = new GlideRecordSecure('sys_data_source');
dataSource.get(dsr);

/*
(2) Step Two: Attach file for processing to the record in Step One.
This is a made up example where we copy an existing attachment from Incident to the Data Source created above
*/
var gsa = new GlideSysAttachment();
var searchStr = "base64,";
var base64String = upd.substring(upd.indexOf(searchStr)+searchStr.length);
var attachmentId = gsa.writeBase64(dataSource, uploadFileName, uploadFileType, base64String);
gs.info('MyDebug -INFO- The attachment sys_id ->' + attachmentId);

/*
(3) Step Three: Load / Process the attached file on the Data Source Record from Step Two.
- Assumes that you have already made an Import set table that is identified in the Data Source Record from Step One.
- Creates an entry in Import Sets [sys_import_set]
- Creates a row by row import created in Import Set Rows [sys_import_set_row]
*/
// var loader = new GlideImportSetLoader();
// var importSetRec = loader.getImportSetGr(dataSource);
// var ranload = loader.loadImportSetTable(importSetRec, dataSource);
// importSetRec.state = "loaded";
// importSetRec.update();

//Create Import Set
var impSet = new GlideRecordSecure('sys_import_set');
//impSet.mode = "asynchronous";
impSet.state = "loaded";
impSet.table_name = uploadTableName;
impSet.short_description = "Type: File\nFormat: " + uploadFileType;
impSet.data_source = dsr; //data source
impSet.load_completed = new GlideDateTime().getDisplayValue();
impSet.load_run_time = new GlideDuration(0);
var impSet_id = impSet.insert();
gs.info('MyDebug -INFO- impSet_id ->' + impSet_id);

//获取明细数据
var datas = JSON.parse(upd2);
var importData = new GlideRecordSecure(impSet.table_name);
var lineBuff = "";
datas.details.forEach(function(item) {
	//gs.info('MyDebug -INFO- item.u_company [' + item.u_company + ']');
	importData.initialize();
	lineBuff = "";
	importData.sys_import_set = impSet_id; //Sys_id of the newly created import set
	for (var i = 0; i < datas.heads.length; i++) {
		var colItem = datas.heads[i];
		var itemValue = item[colItem];
		importData.setValue(colItem, itemValue);
		if (i > 0) lineBuff += ", ";
		lineBuff += colItem + " = [" + itemValue + "]";
	}
	importData.insert();
	// gs.info('MyDebug -INFO- item ->' +  lineBuff);
});

// //Finished loading the import set
// var updImpSet = new GlideRecordSecure('sys_import_set');
// updImpSet.get(impSet_id);
// updImpSet.state = "loaded";
// updImpSet.load_completed = new GlideDateTime().getDisplayValue();
// updImpSet.update();
// gs.info('MyDebug -INFO- impSet loaded');


//var urlOnStack = GlideSession.get().getStack().bottom();
//response.sendRedirect(urlOnStack);
// 转到特定的page
// var uip = new GlideRecordSecure("sys_ui_page");
// if (uip.get(this.sys_id)) {
// 	var pageName = uip.getValue("endpoint");
// 	var url = pageName + "?sysparm_fullname=" + helloName;

// 	response.sendRedirect(encodeURI(url));
// } else {
// 	gs.error(">>>Error: Cannot load ui page: " + this.sys_id);
// }
response.sendRedirect(encodeURI("sys_import_set_list.do"));

]]></processing_script>
        <sys_class_name>sys_ui_page</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-07-15 08:15:22</sys_created_on>
        <sys_id>9555665b93d70210868ab4de3bba100b</sys_id>
        <sys_mod_count>5</sys_mod_count>
        <sys_name>sample_page2</sys_name>
        <sys_package display_value="NeedIt" source="x_58872_needit">6ead8e780f603200cd674f8ce1050ed1</sys_package>
        <sys_policy/>
        <sys_scope display_value="NeedIt">6ead8e780f603200cd674f8ce1050ed1</sys_scope>
        <sys_update_name>sys_ui_page_9555665b93d70210868ab4de3bba100b</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-07-15 10:33:13</sys_updated_on>
    </sys_ui_page>
</record_update>
