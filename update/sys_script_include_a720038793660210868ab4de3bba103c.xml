<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_58872_needit.SavePsiData</api_name>
        <caller_access/>
        <client_callable>true</client_callable>
        <description/>
        <name>SavePsiData</name>
        <script><![CDATA[var SavePsiData = Class.create();
SavePsiData.prototype = Object.extendsObject(global.AbstractAjaxProcessor, {
	save: function() {
		//返回值
		var response = {};
		var result = "";
		var message = "";

		var insertData = [];
		var errorData = [];
		var records = [];

		//检索条件
		var p_invoice_no = "";
		var p_ref_invoice = "";

		var p_invoice_data = this.getParameter("sysparm_invoice_data");
		var p_record_data = this.getParameter("sysparm_record_data");
		//gs.info("p_invoice_data="+p_invoice_data+", p_record_data="+p_record_data);
		var invoice_data = JSON.parse(p_invoice_data);
		p_invoice_no = invoice_data.invoice_no;
		//gs.info("p_invoice_data="+p_invoice_data);

		//检查P1表
		var p_check_table = "x_58872_needit_p1";
		var gr_p1 = new GlideRecordSecure(p_check_table);
		gr_p1.addQuery('invoice_no', p_invoice_no);
		gr_p1.setLimit(1);
		gr_p1.query();
		if (gr_p1.next()) {
			p_ref_invoice = gr_p1.sys_id;
			gr_p1.setValue('total_quantity', invoice_data.total_quantity);
			gr_p1.setValue('total_n_w', invoice_data.total_n_w);
			gr_p1.setValue('total_g_w', invoice_data.total_g_w);
			gr_p1.setValue('total_m3', invoice_data.total_m3);
			gr_p1.update();
		} else {
			message = "无发票数据, invoice_no=" + p_invoice_no;
			result = "ng";
		}
		//释放内存
		gr_p1 = null;

		//设定P0表
		if (result == "" && p_record_data.length > 0) {
			var p_target_table = "x_58872_needit_p0";
			//删除老的invoice_no数据
			var source_query = new global.GlideQuery(p_target_table)
				.where('invoice_no', p_ref_invoice)
				.deleteMultiple();
			//释放内存
			source_query = null;
			//追加新的记录
			var record_datas = JSON.parse(p_record_data);
			var record_data = null;
			var gr_insert = new GlideRecordSecure(p_target_table);
			try {
				for (var i = 0; i < record_datas.length; i++) {
					gr_insert.initialize();
					record_data = record_datas[i];
					gr_insert.setValue('invoice_no', p_ref_invoice);
					gr_insert.setValue('item', record_data.item);
					gr_insert.setValue('quantity', record_data.quantity);
					gr_insert.setValue('n_w', record_data.n_w);
					gr_insert.setValue('g_w', record_data.g_w);
					gr_insert.setValue('m3', record_data.m3);
					gr_insert.insert();

					insertData.push(record_data);
				}
				if (insertData.length > 0) {
					records = insertData;
					result = "ok";
				}
			}
			catch(ex) {
				message = ex.message;
				if (record_data) {
					errorData.push(record_data);
					records = errorData;
				}
				result = "err";
			}
			finally {
				//释放内存
				gr_insert = null;
			}
		}

		//未设定结果的场合
		if (result == "") {
			message = "无明细数据, invoice_no=" + p_invoice_no;
			result = "ng";
		}
		response["result"] = result;
		response["message"] = message;
		response["records"] = records;
		return(JSON.stringify(response));
	},
    type: 'SavePsiData'
});]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-06-07 08:55:42</sys_created_on>
        <sys_id>a720038793660210868ab4de3bba103c</sys_id>
        <sys_mod_count>19</sys_mod_count>
        <sys_name>SavePsiData</sys_name>
        <sys_package display_value="NeedIt" source="x_58872_needit">6ead8e780f603200cd674f8ce1050ed1</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="NeedIt">6ead8e780f603200cd674f8ce1050ed1</sys_scope>
        <sys_update_name>sys_script_include_a720038793660210868ab4de3bba103c</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-06-13 05:24:35</sys_updated_on>
    </sys_script_include>
</record_update>
